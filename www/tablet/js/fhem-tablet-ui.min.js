var deviceStates={};var readings={STATE:true};var devices={};var types=[];var updateStatus={};var DEBUG=false;var DEMO=false;var debuglevel;var TOAST=true;var doLongPoll=false;var timer;var timeoutMenu;var dir="";var filename="";var shortpollInterval=30*1000;var devs=[];var pars=[];var gridster;var styleCollection={};var stdColors=["green","orange","red","ligthblue","blue","gray"];var plugins={modules:[],addModule:function(a){this.modules.push(a)},load:function(name){return loadplugin(name,function(){var module=eval(name);plugins.addModule(module);module.init();for(var device in devices){var params=deviceStates[device];for(var reading in params){if(readings[reading]){module.update(device,reading)}}}for(var reading in readings){if(pars.indexOf(reading)<0){pars.push(reading)}}DEBUG&&console.log("Loaded plugin: "+name)},null,true)},update:function(a,b){$.each(this.modules,function(c,d){d.update(a,b)});DEBUG&&console.log("update done for device:"+a+" parameter:"+b)}};$(document).on("ready",function(){$("<div id='shade' />").prependTo("body").hide();$("#shade").on("click",function(){$(document).trigger("shadeClicked")});loadStyleSchema();initPage();if(doLongPoll){setTimeout(function(){longPoll()},(typeof wvcDevices!="undefined")?shortpollInterval:100);shortpollInterval=15*60*1000}$("*:not(select)").focus(function(){$(this).blur()});startPollInterval()});function initPage(){wx=parseInt($("meta[name='widget_base_width']").attr("content"));wy=parseInt($("meta[name='widget_base_height']").attr("content"));if($("meta[name='widget_margin']").attr("content")){wm=parseInt($("meta[name='widget_margin']").attr("content"))}else{wm=5}doLongPoll=($("meta[name='longpoll']").attr("content")=="1");DEMO=($("meta[name='demo']").attr("content")=="1");debuglevel=$("meta[name='debug']").attr("content")||0;DEBUG=(debuglevel>0);TOAST=($("meta[name='toast']").attr("content")!="0");dir=$('script[src*="fhem-tablet-ui"]').attr("src");var b=dir.split("/").pop();dir=dir.replace("/"+b,"");DEBUG&&console.log("Plugin dir: "+dir);var a=window.location.pathname;filename=a.substring(a.lastIndexOf("/")+1);DEBUG&&console.log("Filename: "+filename);if(gridster){gridster.destroy()}gridster=$(".gridster > ul").gridster({widget_base_dimensions:[wx,wy],widget_margins:[wm,wm],draggable:{handle:".gridster li > header"}}).data("gridster");if($("meta[name='gridster_disable']").attr("content")=="1"){gridster.disable()}if($("meta[name='gridster_starthidden']").attr("content")=="1"){$(".gridster").hide()}var c=$("[data-template]").length;if(c>0){$("[data-template]").each(function(d){$(this).load($(this).data("template"),function(){if(d===c-1){initWidgets()}})})}else{initWidgets()}}function initReadingsArray(c){if(!$.isArray(c)){c=new Array(c)}for(var e=0;e<c.length;e++){var b=c[e];if(b.match(/:/)){var a=b.split(":");var d=a[0];if(!devices[d]){devices[d]=true;devs.push(d)}b=a[1]}if(!readings[b]){readings[b]=true;pars.push(b)}}}function initWidgets(){readings={STATE:true};devices={};types=[];updateStatus={};devs=[];pars=[];if(!DEMO){deviceStates=JSON.parse(localStorage.getItem("deviceStates"))||{}}else{$.ajax({async:false,url:"/fhem/tablet/data/"+filename.replace(".html",".dat")}).done(function(b){deviceStates=JSON.parse(b)||{}})}showDeprecationMsg();$("div[data-type]").each(function(b){var c=$(this).data("type");if(types.indexOf(c)<0){types.push(c)}});$("div[data-device]").each(function(b){var c=$(this).data("device");if(!devices[c]){devices[c]=true;devs.push(c)}});DEBUG&&console.log("Collecting required readings");$("[data-get]").each(function(b){initReadingsArray($(this).data("get"))});var a=$.map(types,function(c,b){return plugins.load("widget_"+c)});$.when.apply(this,a).then(function(){DEBUG&&console.log("Request readings from FHEM");for(var b in readings){requestFhem(b)}})}function showDeprecationMsg(){}function startPollInterval(){clearInterval(timer);timer=setInterval(function(){updateStatus={};for(var a in readings){requestFhem(a)}},shortpollInterval)}function setFhemStatus(a){if(DEMO){console.log("DEMO-Mode: no setFhemStatus");return}startPollInterval();DEBUG&&console.log("send to FHEM: "+a);$.ajax({async:true,url:$("meta[name='fhemweb_url']").attr("content")||"/fhem/",data:{cmd:a,XHR:"1"}}).fail(function(b,d,c){$.toast("Error: "+d+": "+c)}).done(function(b){if(!doLongPoll){setTimeout(function(){for(var c in readings){requestFhem(c)}},4000)}})}var xhr;var currLine=0;function longPoll(a){if(DEMO){console.log("DEMO-Mode: no longpoll");return}DEBUG&&console.log("start longpoll");if(xhr){xhr.abort()}currLine=0;$.ajax({url:$("meta[name='fhemweb_url']").attr("content")||"/fhem/",cache:false,complete:function(){setTimeout(function(){longPoll()},100)},timeout:60000,async:true,data:{XHR:1,inform:"type=raw;filter=.*"},xhr:function(){xhr=new window.XMLHttpRequest();xhr.addEventListener("readystatechange",function(o){var k=o.target.responseText;if(o.target.readyState==4){return}if(o.target.readyState==3){var t=k.replace(/<br>/g,"").split(/\n/);var h=/\s[0-2][0-9]:[0-5][0-9]:[0-5][0-9]\.?[0-9]{0,3}\s(\S*)\s(\S*)\s(.*)/;var m=/^([0-9]{4}-[0-9]{2}-[0-9]{2}\s[0-2][0-9]:[0-5][0-9]:[0-5][0-9])\.?[0-9]{0,3}\s/;var d=/^(\S{2,}):(?:\s(.*))?$/;t.pop();for(var l=currLine,n=t.length;l<n;l++){var g;var s=$.trim(t[l]);if(m.test(s)){g=$.trim(s.match(m)[1])}if(h.test(s)){var b=$.trim(s.match(h)[1]);var r=$.trim(s.match(h)[2]);var q=$.trim(s.match(h)[3]);var j=deviceStates[r]||{};var c;var f;if(d.test(q)){var c=$.trim(q.match(d)[1]);var f=$.trim(q.match(d)[2])}else{var c="STATE";var f=q}if(((b=="readingsGroup")&&(r in devices))||((c in readings)&&(r in devices))){var p={date:g,room:b,val:f};j[c]=p;deviceStates[r]=j;DEBUG&&console.log(g+" / "+r+" / "+c+" / "+f);plugins.update(r,c)}}}currLine=t.length}},false);return xhr}})}function requestFhem(b,d){if(DEMO){console.log("DEMO-Mode: no requestFhem");return}var a;if(b.match(/:/)){var c=b.split(":");d=c[0];b=c[1]}if(typeof d!="undefined"&&d!=="undefined"){a=d}else{a=$.map(devs,$.trim).join()}if(typeof b!="undefined"&&b!=="undefined"){$.ajax({async:true,timeout:15000,cache:false,context:{paraname:b},url:$("meta[name='fhemweb_url']").attr("content")||"/fhem/",data:{cmd:["list",a,b].join(" "),XHR:"1"}}).fail(function(e,g,f){$.toast("Error: "+g+": "+f)}).done(function(l){var s=l.replace(/\n\)/g,")\n").split(/\n/);var o=/^(\S*)\s*([0-9]{4}-[0-9]{2}-[0-9]{2}\s[0-2][0-9]:[0-5][0-9]:[0-5][0-9])?\.?[0-9]{0,3}\s+(.*)$/;for(var m=0,n=s.length;m<n;m++){var h="";var q="";var g="";var r=$.trim(s[m]);if(debuglevel>=6){console.log("line: "+r)}if(o.test(r)){var f=r.match(o);var e=this.paraname;q=$.trim(r.match(o)[1]);if(q in devices){if(f.length>2){h=$.trim(f[2]);g=$.trim(f[3])}if(debuglevel>=5){console.log("requestFhem::done: Line parser result: key:"+q+" paraname:"+e+" date:"+h+" val:"+g)}var k=getParameterByName(q,e);if(!k||k.val!=g||k.date!=h){var j=deviceStates[q]||{};var p={date:h,val:g};j[e]=p;deviceStates[q]=j;plugins.update(q,e)}}}}saveStatesLocal()})}}$(window).on("beforeunload",function(){saveStatesLocal()});function saveStatesLocal(){var a=JSON.stringify(deviceStates);localStorage.setItem("deviceStates",a)}function loadplugin(c,d,a,b){return dynamicload("js/"+c+".js",d,a,b)}function dynamicload(c,e,b,d){var a=(DEBUG)?false:true;return $.ajax({url:dir+"/../"+c,dataType:"script",cache:a,async:d||false,context:{name:name},success:e||function(){return true},error:b||function(){return false}})}function loadStyleSchema(){$.each($('link[href$="-ui.css"],link[href$="-ui.min.css"]'),function(e,b){var f=b.sheet.cssRules;for(var a in f){if(f[a].style){var h=f[a].style.cssText.split(";");h.pop();var g=f[a].selectorText;var d={};for(var i in h){var c=h[i].split(":");if(c[0].match(/color/)){d[$.trim(c[0])]=$.trim(c[1]).replace("! important","").replace("!important","")}}if(Object.keys(d).length>0){styleCollection[g]=d}}}})}this.getPart=function(d,f){if($.isNumeric(f)){var g=(d&&typeof d!="undefined")?d.split(" "):"";return(g.length>=f&&f>0)?g[f-1]:d}else{if((d&&typeof d!="undefined")){var e=d.match(new RegExp("^"+f+"$"))}var a="";if(e){for(var b=1;b<e.length;b++){a+=e[b]}}return a}};this.getDeviceValueByName=function(b,a){var c=getParameterByName(b,a);return(c)?c.val:null};this.getDeviceValue=function(a,c){var b=getParameter(a,c);return(b)?b.val:null};this.getReadingDateByName=function(b,a){var c=getParameterByName(b,a);return(c)?c.date:null};this.getReadingDate=function(a,c){var b=getParameter(a,c);return(b)?b.date:null};this.getParameterByName=function(c,a){if(c.match(/:/)){var b=c.split(":");c=b[0];a=b[1]}a=a||Object.keys(readings)[0];if(c&&c.length>0){var d=deviceStates[c];return(d&&d[a])?d[a]:null}return null};this.getParameter=function(c,e){var b=c.data("device");var a=(e&&e!="")?c.data(e):Object.keys(readings)[0];if(b&&b.length>0){var d=deviceStates[b];return(d&&d[a])?d[a]:null}return null};this.hasSubscription=function(f,a){var c=f.data("get");if(!$.isArray(c)){c=new Array(c)}var d;if(a.match(/,/)){d=a.split(",")}else{d=new Array(a)}for(var e=0;e<c.length;e++){for(var h=0;h<d.length;h++){var b;if(c[e]&&c[e].match(/:/)){b=c[e].split(":")[1]}else{b=c[e]}if(d[h]==b){return true}}}return false};this.getStyle=function(a,c){var b=styleCollection[a];return(b&&b[c])?b[c]:null};this.getClassColor=function(c){for(var b=0,a=stdColors.length;b<a;b++){if(c.hasClass(stdColors[b])){return getStyle("."+stdColors[b],"color")}}return null};this.getIconId=function(d){if(!d||d==""){return"?"}var b=$('link[href$="font-awesome.min.css"]')[0].sheet.cssRules;for(var a in b){if(b[a].selectorText&&b[a].selectorText.match(new RegExp(d+":"))){var c=b[a].style.content;return(c)?c.replace(/"/g,"").replace(/'/g,""):"?"}}};this.showModal=function(a){if(a){$("#shade").fadeIn()}else{$("#shade").fadeOut()}};this.dateFromString=function(d){var a=d.match(/(\d+)-(\d+)-(\d+)_(\d+):(\d+):(\d+).*/);var b=d.match(/(\d\d).(\d\d).(\d\d\d\d)/);var c=new Date().getTimezoneOffset();return(a)?new Date(+a[1],+a[2]-1,+a[3],+a[4],+a[5],+a[6]):(b)?new Date(+b[3],+b[2]-1,+b[1],0,-c,0,0):new Date()};this.diffMinutes=function(b,a){diff=new Date(a-b);return(diff/1000/60).toFixed(0)};String.prototype.toDate=function(){return dateFromString(this)};Date.prototype.yyyymmdd=function(){var c=this.getFullYear().toString();var b=(this.getMonth()+1).toString();var a=this.getDate().toString();return c+"-"+(b[1]?b:"0"+b[0])+"-"+(a[1]?a:"0"+a[0])};Date.prototype.hhmm=function(){var a=this.getHours().toString();var b=this.getMinutes().toString();return(a[1]?a:"0"+a[0])+":"+(b[1]?b:"0"+b[0])};Date.prototype.hhmmss=function(){var b=this.getHours().toString();var c=this.getMinutes().toString();var a=this.getSeconds().toString();return(b[1]?b:"0"+b[0])+":"+(c[1]?c:"0"+c[0])+":"+(a[1]?a:"0"+a[0])};Date.prototype.ddmm=function(){var b=(this.getMonth()+1).toString();var a=this.getDate().toString();return(a[1]?a:"0"+a[0])+"."+(b[1]?b:"0"+b[0])+"."};Date.prototype.eeee=function(){var c=["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];var b=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];var a=navigator.language||navigator.userLanguage;if(a.split("-")[0]==="de"){return c[this.getDay()]}return b[this.getDay()]};Date.prototype.eee=function(){var c=["Son","Mon","Die","Mit","Don","Fre","Sam"];var b=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var a=navigator.language||navigator.userLanguage;if(a.split("-")[0]==="de"){return c[this.getDay()]}return b[this.getDay()]};Date.prototype.ee=function(){var c=["So","Mo","Di","Mi","Do","Fr","Sa"];var b=["Su","Mo","Tu","We","Th","Fr","Sa"];var a=navigator.language||navigator.userLanguage;if(a.split("-")[0]==="de"){return c[this.getDay()]}return b[this.getDay()]};this.indexOfGeneric=function(c,b){if(!c){return -1}for(var a=0;a<c.length;a++){if(!$.isNumeric(c[a])){return indexOfRegex(c,b)}}return indexOfNumeric(c,b)};this.indexOfNumeric=function(d,c){var a=-1;for(var b=0;b<d.length;b++){if(Number(c)>=Number(d[b])){a=b}}return a};this.indexOfRegex=function(f,d){for(var b=0;b<f.length;b++){try{var a=d.match(new RegExp("^"+f[b]+"$"));if(a){return b}}catch(c){}}return f.indexOf(d)};